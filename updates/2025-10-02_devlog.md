# Development Log - 2025-10-02

## Summary
- Fixed admin role gating and session bleed issues; simplified Google sign-in by moving Calendar consent to Settings.
- Added telemetry/logging to observe OAuth attempts and bounces before user creation.
- Resolved TypeScript union errors in Convex webhook handler.
- Current blocker: Some Google accounts complete the 5-screen OAuth but are not created in Clerk and get bounced back to login.

## Changes Implemented
1) Admin & Auth
- convex/auth/admin.ts: return strict boolean; accept userId OR email OR publicMetadata.isAdmin. Logs now show correct matches.
- Frontend: clear persisted session on sign-out; guard conversation query against stale session IDs.

2) Calendar consent moved to Settings
- Removed global additionalOAuthScopes from ClerkProvider (keeps login minimal).
- Settings → Connected Apps: added Google Calendar card with Connect/Disconnect/Test using Clerk OAuth (scopes requested on demand).

3) Telemetry and Logging
- convex/http.ts: added POST /telemetry/oauth-callback to log OAuth callback/bounce info from the client.
- App.tsx: posts telemetry on Clerk OAuth callback (and on bounce without __clerk params); surfaces callback error text.
- CustomAuthForm.tsx: posts telemetry at signin_start/signin_error.
- convex/http.ts Clerk webhook handler: widened switch discriminator and default-logs any session*/oauth* events; logs session.created.

4) TypeScript fixes
- Removed non-union case labels (user.oauth_access_token.created, oauth.access_token.created); now handled in default branch. tsc passes locally.

## Observations
- Admin (wahabbasa@gmail.com) and one non-admin (wahabekky@gmail.com) work; admin menu visibility correct.
- Two newer Google accounts face 5 screens and get redirected back to login; Clerk Dashboard does not list them (user not created).
- Not a Google Console Test Users issue; looks Clerk-side (sign-up restrictions/instance/parity). Telemetry added to capture errors pre-creation.

## Current Blocker
- Some Google sign-ups are not being added to Clerk (no user.created event, bounced back to login).

## Verification/Checklist (Clerk & App)
- Instance parity: PUBLISHABLE_KEY (.env) and CLERK_JWT_ISSUER_DOMAIN (Convex env) must point to the same Clerk instance.
- Allowed origins/redirects in Clerk include http://localhost:5173.
- Authentication → Sign in & Sign up: “Disallow sign ups” OFF; no invite/allowlist/domain restrictions (or add failing emails/domains explicitly); no extra required fields Google doesn’t supply.
- Social connections → Google: Enabled and “Allow sign ups” ON.
- Webhooks: Clerk → Add endpoint to Convex /clerk with correct CLERK_WEBHOOK_SECRET; select user.* and session.* (and oauth.* if available) events.
- App env: VITE_CONVEX_URL set in ea-ai-main2/.env.local so signed-out telemetry POSTs succeed.

## Files Touched Today
- convex/auth/admin.ts
- convex/http.ts
- src/components/providers.tsx
- src/views/SettingsView.tsx
- src/App.tsx
- src/components/CustomAuthForm.tsx

## Next Steps
1) Confirm VITE_CONVEX_URL is set; retest failing accounts and inspect Convex logs [TELEMETRY][OAUTH] entries for error codes.
2) Verify Clerk webhook delivery for session/user events during failing attempts; check Clerk Logs for not_allowed_to_sign_up/access_denied.
3) If needed, temporarily disable sign-up restrictions or explicitly allow the failing emails/domains, then retest.
4) Once confirmed, keep Calendar consent in Settings only to avoid heavy consent flow on login.

## Status
- Login/admin role: fixed.
- Calendar consent: moved to Settings; works via on-demand connect.
- Outstanding: Clerk sign-up gap for two Google accounts; awaiting telemetry/log review and Clerk config confirmation.

---

## Afternoon Update – OAuth loop resolved, blank page fixed, global model defaults

Changes
- Frontend auth flow:
  - Added dedicated callback page and universal guard; now always finalize Clerk OAuth when `__clerk` is present or on `/sso-callback`.
  - Switched to `handleRedirectCallback` with forced `location.replace('/')` and cleanup of stale `__clerk` params to eliminate manual refresh/blank page.
  - Limited the "Completing sign in…" overlay to the explicit callback route only.
- Local-first auth UX: kept `CustomAuthForm` for sign-in/sign-up; prevented re-login loops by ignoring residual params after session is active.
- Global model defaults: when admin saves provider config, we upsert a `__GLOBAL__` defaults row; backend now falls back to these defaults if a user has no personal `activeModelId`.

Verification
- Re-login with same account: no loop, no manual refresh; immediate redirect to chat after brief callback.
- Non-admin users can chat without selecting a model explicitly (inherit from global defaults).

Touched Files (additional)
- src/components/AuthCallback.tsx (new)
- src/lib/telemetry.ts (new)
- src/App.tsx (guards + overlay + telemetry scope)
- convex/providers/unified.ts (admin upserts global defaults)
- convex/ai/session.ts (global defaults fallback)


