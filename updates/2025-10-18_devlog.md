## Per-user monthly token cap via OpenRouter + Vercel AI SDK (01:08)

**Status**: âœ… Hard cap of 1,000,000 tokens/user/month enforced with server-side accounting

### Context
Goal was to add robust, per-user token quota enforcement without custom tokenizers, leveraging Vercel AI SDK usage and OpenRouter features. We chose append-only accounting + pre-checks + per-call output caps to prevent single-call overflow.

### Implementation

1) Schema additions (convex/schema.ts:383-410)
- Added `usageEvents` table with indexes `by_tokenIdentifier` and `by_tokenIdentifier_and_ts`
- Added `usageQuotas` table for per-user monthly cap overrides (defaults applied in logic)

2) Usage API (convex/usage.ts:1-58)
- `getMonthlyTotal(tokenIdentifier, monthStart?)` sums totalTokens in current month
- `getMonthlyCap(tokenIdentifier)` returns override or default 1,000,000
- `recordEvent(...)` inserts append-only usage record per request

3) Enforcement in chat pipeline (convex/ai/session.ts:497-503, 582-589, 617-632)
- Pre-check monthly usage and cap; reject if exhausted; compute `remainingMonthly`
- Set `maxTokens` in model call to prevent exceeding remaining budget in a single call
- After response, persist `result.usage` to `usageEvents`
- Also added OpenRouter `extraBody.user = tokenIdentifier` for per-user routing/analytics

### Result
All requests now respect a hard monthly per-user token budget. If at cap, user receives quota-exceeded error; otherwise, output tokens are limited to remaining monthly budget. Usage is recorded append-only for accurate rollups. OpenRouter receives stable per-user `user` field for analytics.

### Files Changed
- `convex/schema.ts` (usageEvents, usageQuotas tables + indexes)
- `convex/usage.ts` (new)
- `convex/ai/session.ts` (pre-check, maxTokens, post-record, OpenRouter user)

### Next
- Optional: Add RPM/RPH request rate caps; add admin overrides UI
- Add monthly rollups for faster analytics

### Post-Implementation Update - Stripe References Removed
Removed all references to specific payment processors (Stripe) from both files:
- PrivacyPolicy.tsx: Changed "processed securely by Stripe" to generic "third-party payment provider"
- TermsOfService.tsx: Removed Stripe reference, changed to generic payment provider language
- TermsOfService.tsx: Removed "payment processor policies" from refund section

Files updated to remain payment-agnostic and not reveal specific processor details.

