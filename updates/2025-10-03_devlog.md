## 2025-10-03 — Streaming Chat Refactor (Convex httpAction + AI SDK useChat)

Summary
- Implemented true token-by-token streaming via Convex httpAction and Vercel AI SDK useChat.
- Added new backend endpoint and refactored frontend chat context; dev proxy to avoid CORS.
- Fixed TS types for provider init and onFinish handling per AI SDK v5.

Changes
- Backend:
  - Added: ea-ai-main2/ea-ai-main2/convex/ai/stream.ts (httpAction using streamText; persists onFinish).
  - Updated: ea-ai-main2/ea-ai-main2/convex/http.ts (register POST /chat -> stream action).
- Frontend:
  - Updated: ea-ai-main2/ea-ai-main2/src/context/chat.tsx (switch to @ai-sdk/react useChat; Clerk auth header; normalize messages).
  - Updated: ea-ai-main2/ea-ai-main2/vite.config.ts (proxy /convex-http/* to Convex dev).

Notes
- onFinish must be passed to streamText (finish.response.messages), not to toUIMessageStreamResponse.
- Google Vertex provider used via providerClient.any().chat(modelName) pattern mirroring session.ts.
- Persisted assistant message uses messageSchemas.createEmbeddedMessage.

Next
- Validate tool call/result embedding in persisted history.
- Expand error telemetry and usage metrics.

---

Runtime Fixes — Convex runtimes alignment (Node vs default JS)

Summary
- Investigated bundling errors (Could not resolve net/http/tls) caused by Node-only deps used from Convex isolate runtime.
- Per Convex docs, functions using Node APIs must opt into Node runtime with "use node" at file top.

Changes
- Keep Node runtime only where required:
  - Added "use node" to: convex/ai/compaction.ts, convex/ai/subagents/executor.ts.
- HTTP streaming endpoint must run in Convex default JS runtime:
  - Removed "use node" from convex/ai/stream.ts; removed Vertex import; restricted streaming endpoint to OpenRouter only (fetch-based). If provider === google, returns 400 with guidance.
  - convex/http.ts cannot use Node runtime; switched `@clerk/backend` to type-only import to avoid bundling Node deps.

Status
- Bundling errors for Node built-ins from httpAction are resolved by isolating Node-only deps to Node actions and keeping httpAction Node-free.
- Frontend follow-up: saw "Cannot read properties of undefined (reading 'trim')" during UI run; likely a message/part normalization issue to address next.

References
- Convex docs: Functions → Actions → Node.js runtime ("use node").
- Vercel AI SDK streaming examples assume Node server backends.

