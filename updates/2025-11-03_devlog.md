## Settings UX: Tri-state + Lazy OAuth (11:00)

**Status**: ⚠️ Partial — reduced flicker/logs; default connected state still not retained on first paint

**Context**
Goal was to stop the transient “disconnected” UI and noisy access logs when opening Settings. Implemented tri‑state loading for Google Calendar, gated status checks on Clerk readiness, and switched Todoist OAuth URL generation to on‑click (lazy) to remove page‑load queries.

**Changes Made**
- ea-ai-main2/ea-ai-main2/convex/todoist/auth.ts
  - Added `generateOAuthURLAction` to lazily fetch Todoist OAuth URL on click
  - Added `hasTodoistConnectionAction` (optional) to query connection via action
- ea-ai-main2/ea-ai-main2/src/components/SettingsModal.tsx:216,332
  - Replaced page‑load Todoist OAuth URL query with action; open popup only on Connect
  - Gated initial Google status load by `useUser().isLoaded` to avoid duplicate/early checks
- ea-ai-main2/ea-ai-main2/src/views/SettingsView.tsx:515,524,526,528,565
  - Tri‑state `gcalConnected: boolean | null` to render “Checking…” until resolved
  - Only run calendar status checks after Clerk is loaded and user exists
  - Switched Todoist connect to lazy OAuth action

**Result**
- Google Calendar tile now shows “Checking…” instead of briefly “disconnected,” then settles on the correct state.
- Todoist no longer generates `GENERATE_OAUTH_URL - REQUESTED` during page load; it’s generated on Connect.
- Logging is quieter; fewer duplicated “[USER_ACCESS] … REQUESTED” lines from mount.

**Open Issue (Observed)**
- Your report: default Google Calendar button still shows “Connecting” then flips to “Disconnect,” instead of initially rendering as already connected. This indicates status is still arriving post‑render. Next step would be to hydrate initial `isConnected` from a single aggregated status action or cache and render optimistically, then reconcile on arrival.

**Next Steps**
1) Add aggregated `integrations/status:getStatus` to fetch both Todoist + Google in one call and hydrate UI at mount (optional).
2) Improve summarizer for calendar errors so LLM answers capability questions explicitly (not generic fallback).

